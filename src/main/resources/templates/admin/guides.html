<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farming Guides Management - KrishiTech Admin</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <link rel="stylesheet" th:href="@{admin.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar" id="adminSidebar">
      <div class="admin-sidebar-header">
        <div class="admin-sidebar-logo">
          <h1>KrishiTech</h1>
        </div>
        <button class="admin-sidebar-toggle" id="sidebarToggle">
          <i class="fas fa-bars"></i>
        </button>
      </div>

      <nav class="admin-sidebar-menu">
        <ul>
          <li>
            <a th:href="@{adminDashboard}">
              <i class="fas fa-tachometer-alt"></i>
              <span>Dashboard</span>
            </a>
          </li>
          <li>
            <a th:href="@{users}">
              <i class="fas fa-users"></i>
              <span>User Management</span>
            </a>
          </li>
          <li>
            <a th:href="@{adminGuides}" class="active">
              <i class="fas fa-book"></i>
              <span>Farming Guides</span>
            </a>
          </li>
          <li>
            <a th:href="@{forums}">
              <i class="fas fa-comments"></i>
              <span>Forums</span>
            </a>
          </li>
          <li>
            <a th:href="@{marketData}">
              <i class="fas fa-chart-line"></i>
              <span>Market Data</span>
            </a>
          </li>
<!--          <li>-->
<!--            <a th:href="@{adminMachinery}">-->
<!--              <i class="fas fa-tractor"></i>-->
<!--              <span>Machinery Listings</span>-->
<!--            </a>-->
<!--          </li>-->
        </ul>
      </nav>
    </aside>
    
    <!-- Main Content -->
    <main class="admin-content">
      <!-- Header -->
      <header class="admin-header">
        <div class="admin-header-title">
          <h1>Farming Guides Management</h1>
          <div class="admin-header-breadcrumb">
            <a href="dashboard.html">Home</a>
            <span>/</span>
            <span>Farming Guides</span>
          </div>
        </div>
        
        <div class="admin-header-actions">
<!--          <div class="admin-search">-->
<!--            <i class="fas fa-search"></i>-->
<!--            <input type="text" placeholder="Search guides...">-->
<!--          </div>-->
          
          <div class="admin-user-menu" id="userMenu">
            <button class="admin-user-button" id="userMenuButton">
              <div class="admin-user-avatar">
                <span th:text="${(session.userName.contains(' ') ?
                (#strings.substring(session.userName, 0, 1) + #strings.substring(session.userName, session.userName.indexOf(' ') + 1, session.userName.indexOf(' ') + 2)):
                (#strings.substring(session.userName, 0, 1))).toUpperCase()}"></span>
              </div>
              <div class="admin-user-info">
                <div class="admin-user-name" th:text="${session.userName}"></div>
                <div class="admin-user-role" th:text="${session.role}"></div>
              </div>
            </button>
            
            <div class="admin-user-dropdown" id="userDropdown">
              <ul>
                <div class="admin-user-dropdown-divider"></div>
                <li>
                  <a th:href="@{/adminLogout}">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <div th:if="${param.error}" class="alert alert-danger alert-dismissible fade show fixed-top mx-auto mt-3" style="max-width: 900px; z-index: 1100;" role="alert">
        <span th:text="${param.error}">Invalid credentials!</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>

      <!-- Guides Management Content -->
      <div class="admin-dashboard-grid">
        <!-- Guide Categories Section -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">Guide Categories</h3>
            <div class="admin-card-actions">
              <button class="btn btn-primary" id="addCategoryBtn" type="submit">
                <i class="fas fa-plus"></i> Add Category
              </button>
            </div>
          </div>
          
          <div class="admin-table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Icon</th>
                  <th>Category Name</th>
                  <th>Description</th>
                  <th>Guides Count</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="category: ${categories}">
                  <td> <i th:class="${category.iconClass}"></i></td>
                  <td th:text="${category.name}"></td>
                  <td th:text="${category.description}"></td>
                  <td th:text="${category.guidesCount}"></td>
                  <td><span class="admin-status" th:classappend="${category.status == 'on'} ? ' active' : ' inactive'"
                            th:text="${category.status == 'on'} ? 'Active' : 'Inactive'"></span></td>

                  <td>
                    <div class="admin-table-actions">
                      <button th:onclick="'editCategory(' + ${category.id} + ')'" class="admin-table-action edit">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button th:onclick="'deleteCategory(' + ${category.id} + ')'" class="admin-table-action delete">
                        <i class="fas fa-trash-alt"></i>
                      </button>

                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Guide Statistics Section -->
        <div class="admin-card">
          <div class="admin-card-header">
            <h3 class="admin-card-title">Guide Statistics</h3>
          </div>
          
          <div class="admin-stat-card">
            <div class="admin-stat-icon primary">
              <i class="fas fa-book"></i>
            </div>
            <div class="admin-stat-content">
              <h3 class="admin-stat-value" th:text="${guides.size()}"></h3>
              <p class="admin-stat-label">Total Guides</p>
            </div>
          </div>
          
          <div class="admin-chart-container" id="guidesViewsChart">
            <!-- Chart will be rendered here by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Farming Guides List -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h3 class="admin-card-title">Farming Guides</h3>
          <div class="admin-card-actions">
            <button class="btn btn-primary" id="addFarmGuideBtn" type="submit">
              <i class="fas fa-plus"></i> Add New Guide
            </button>
          </div>
        </div>

        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Source</th>
                <th>Published Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="guide: ${guides}">
                <td th:text="${guide.title}"></td>
                <td th:text="${guide.category}"></td>
                <td th:text="${guide.sourceName}"></td>

                <td th:text="${#temporals.format(guide.createdAt, 'MMMM d, yyyy')}"></td>
                <td>
                 <span class="admin-status"
                       th:classappend="${#strings.trim(guide.status) == 'published'} ? ' active' : ' inactive' "
                       th:text="${#strings.trim(guide.status) == 'published'} ? 'Published' : 'Draft'"></span>

                </td>
                <td>
                  <div class="admin-table-actions">
                    <button th:onclick="'editFarmGuide('+${guide.id}+')'" class="admin-table-action edit">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button th:onclick="'readFarmGuide('+${guide.id}+')'" class="admin-table-action">
                      <i class="fas fa-eye"></i>
                    </button>
                    <button th:onclick="'deleteFarmGuide('+${guide.id}+')'" class="admin-table-action delete">
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </div>
                </td>
              </tr>

            </tbody>
          </table>
        </div>

        <div class="admin-pagination" th:if="${totalPages > 1}">
          <!-- Pagination Info -->
          <div class="admin-pagination-info">
            Showing
            <span th:text="${(currentPage - 1) * size + 1}">1</span>
            to
            <span th:text="${(currentPage * size) > totalItems ? totalItems : (currentPage * size)}">7</span>
            of
            <span th:text="${totalItems}"></span> entries
          </div>

          <!-- Pagination Buttons -->
          <div class="admin-pagination-buttons">

            <!-- Prev Button -->
            <button class="admin-pagination-button"
                    th:disabled="${currentPage == 1}"
                    th:onclick="|window.location.href='adminGuides?page=${currentPage - 1}&size=${size}'|">
              <i class="fas fa-chevron-left"></i>
            </button>

            <!-- Page Numbers with Ellipses -->
            <th:block th:each="i : ${#numbers.sequence(1, totalPages)}">
              <th:block th:if="${i == 1 || i == totalPages || (i >= currentPage - 2 && i <= currentPage + 2)}">
                <button class="admin-pagination-button"
                        th:classappend="${i == currentPage} ? ' active' : ''"
                        th:onclick="|window.location.href='adminGuides?page=${i}&size=${size}'|">
                  <span th:text="${i}">1</span>
                </button>
              </th:block>
              <span th:if="${i == currentPage - 3 || i == currentPage + 3}">...</span>
            </th:block>

            <!-- Next Button -->
            <button class="admin-pagination-button"
                    th:disabled="${currentPage == totalPages}"
                    th:onclick="|window.location.href='adminGuides?page=${currentPage + 1}&size=${size}'|">
              <i class="fas fa-chevron-right"></i>
            </button>

          </div>
        </div>

      </div>

      <!-- Featured Guides Section -->
      <div class="admin-card">
        <div class="admin-card-header">
          <h3 class="admin-card-title">Featured Guides</h3>
          <div class="admin-card-actions">
            <button class="btn btn-primary" id="manageFeaturedBtn">
              <i class="fas fa-star"></i> Manage Featured
            </button>
          </div>
        </div>
        
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Title</th>
                <th>Category</th>
                <th>Position</th>
                <th>Featured Since</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <tr th:each="featuredGuide :${featuredGuides}">
                <td th:text="${featuredGuide.title}"></td>
                <td th:text="${featuredGuide.category}">Pest Control</td>
                <td th:text="${featuredGuide.featuredPosition}"></td>
                <td th:text="${#temporals.format(featuredGuide.createdAt, 'MMMM d, yyyy')}"></td>
                <td>
                  <div class="admin-table-actions">
                    <button class="admin-table-action" th:onclick="'movePositionUp('+${featuredGuide.id}+')'">
                      <i class="fas fa-arrow-up"></i>
                    </button>
                    <button class="admin-table-action" th:onclick="'movePositionDown('+${featuredGuide.id}+')'">
                      <i class="fas fa-arrow-down"></i>
                    </button>
                    <button class="admin-table-action delete" th:onclick="'isNotFeatured('+${featuredGuide.id}+')'">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </td>
              </tr>
              </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

<!--  category adding modal-->
  <div id="addCategoryModal" class="admin-modal">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3>Add New Category</h3>
        <button class="admin-modal-close">&times;</button>
      </div>
      <div class="admin-modal-body">
        <form id="addCategoryForm" th:action ="@{/addGuideCategory}" method="post" th:object="${guide}">
          <div class="admin-form-group">
            <label for="categoryName">Category Name</label>
            <input type="text" id="categoryName" name="name" required>
          </div>
          <div class="admin-form-group">
            <label for="categoryDescription">Description</label>
            <textarea id="categoryDescription" rows="3" name="description"></textarea>
          </div>
          <div class="admin-form-group">
            <label for="CategoryIcon">Icon</label>
            <input type="text" id="CategoryIcon" name="iconClass" placeholder="For eg: fas fa-seedling">
          </div>
          <div class="admin-form-group">
            <label class="admin-switch">
              <input type="checkbox" id="categoryStatus" name="status">
              <span class="admin-slider round"></span>
            </label>
          </div>

          <input type="hidden" id="editId" name="id">
          <div class="admin-form-actions">
            <button type="reset" class="btn btn-secondary">Clear</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

<!--  // for new guides addition-->
  <div id="addGuideModal" class="admin-modal">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <h3>Add New Farming Guide</h3>
        <button class="admin-modal-close">&times;</button>
      </div>
      <div class="admin-modal-body">
        <form id="addGuideForm" th:action ="@{/createFarmGuide}" method="post" th:object="${farmGuide}" enctype="multipart/form-data">
          <div class="admin-form-group">
            <label for="title">Title</label>
            <input type="text" id="title" name="title" required>
          </div>
          <div class="admin-form-group">
            <label for="excerpt">Excerpt</label>
            <textarea id="excerpt" rows="2" name="excerpt" style="min-height: 40px;" required></textarea>
          </div>
          <div class="admin-form-group">
            <label for="content">Content</label>
            <textarea id="content" rows="3" name="content" required></textarea>
          </div>
          <div class="admin-form-group">
            <label for="featuredImage">Image</label>
            <input type="file" id="featuredImage" name="featuredImage" accept="image/*">
          </div>

          <div class="same-row">
          <div class="admin-form-group">
            <label>Category</label>
            <select name="category" id="category">
              <option value="">Choose Category</option>
              <option th:each="category : ${categories}"
                      th:value="${category.name}"
                      th:text="${category.name}">
            </select>
          </div>
            <div class="admin-form-group">
              <label for="subcategory">Subcategory</label>
              <input type="text" id="subcategory" name="subcategory">
            </div>

          <div class="admin-form-group">
            <label>Status</label>
            <select name="status" id="status">
              <option value="draft">Draft</option>
              <option value="published">Published</option>
            </select>
          </div>
          </div>
          <div class="same-row">
          <div class="admin-form-group">
            <label for="sourceName">Source name</label>
            <input type="text" id="sourceName" name="sourceName">
          </div>
          <div class="admin-form-group">
            <label for="sourceUrl">Source url</label>
            <input type="text" id="sourceUrl" name="sourceUrl">
          </div>
          <div class="admin-form-group">
            <label for="keywords">Keywords</label>
            <input type="text" id="keywords" name="keywords">
          </div>
          </div>
          <div class="admin-form-group">
            <label>Is Featured?</label>
            <div class="radio-row">
              <label><input type="radio" name="featured" value="true"> Yes</label>
              <label><input type="radio" name="featured" value="false" checked> No</label>
            </div>
          </div>

          <input type="hidden" id="slug" name="slug">
          <input type="hidden" id="editFarmId" name="id">
          <div class="admin-form-actions">
            <button type="reset" class="btn btn-secondary">Clear</button>
            <button type="submit" class="btn btn-primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Read Guide Modal -->
  <div id="readGuideModal" class="admin-modal">
    <div class="admin-modal-content">
      <div class="admin-modal-header">
        <button class="admin-modal-close">&times;</button>
      </div>
      <div class="admin-modal-body">
        <div class="guide-detail-container">
          <div class="guide-header">
            <h1 id="readGuideTitle"></h1>
            <div class="guide-header-meta">
              <div class="guide-date">
                <i class="fas fa-calendar-alt"></i>
                <span id="readGuideDate"></span>
              </div>
            </div>
            <div class="guide-featured-image" id="readGuideImage"></div>
          </div>
          <div class="guide-content-wrapper">
            <p id="readGuideContent"></p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script th:src="@{/admin.js}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Initialize the guides views chart if it exists
      const guidesViewsChart = document.getElementById("guidesViewsChart");

      if (guidesViewsChart) {
        new Chart(guidesViewsChart, {
          type: "line",
          data: {
            labels: ["Jan", "Feb", "Mar", "Apr", "May", "Jun"],
            datasets: [
              {
                label: "Guide Views",
                data: [5200, 6100, 7300, 8200, 9500, 10800],
                borderColor: "#4caf50",
                backgroundColor: "rgba(76, 175, 80, 0.1)",
                tension: 0.3,
                fill: true,
              }
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: "top",
              },
              tooltip: {
                mode: "index",
                intersect: false,
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false,
                },
              },
              x: {
                grid: {
                  display: false,
                },
              },
            },
          },
        });
      }

      // Modal functionality
      const addCategoryBtn = document.getElementById('addCategoryBtn');
      const modal = document.getElementById('addCategoryModal');
      const closeButtons = document.querySelectorAll('.admin-modal-close');

      if (addCategoryBtn && modal) {
        addCategoryBtn.addEventListener('click', () => {
          modal.style.display = 'block';
        });

        closeButtons.forEach(button => {
          button.addEventListener('click', () => {
            modal.style.display = 'none';
          });
        });

        window.addEventListener('click', (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });


        document.getElementById('categoryStatus')?.addEventListener('change', function() {
          const statusText = this.parentElement.querySelector('.admin-status-text');
          if (this.checked) {
            statusText.textContent = 'Active';
            statusText.classList.remove('inactive');
            statusText.classList.add('active');
          } else {
            statusText.textContent = 'Inactive';
            statusText.classList.remove('active');
            statusText.classList.add('inactive');
          }
        });
      }

      // GuideModal functionality
      const addGuideBtn = document.getElementById('addFarmGuideBtn');
      const guideModal = document.getElementById('addGuideModal');

      if (addGuideBtn && guideModal) {
        addGuideBtn.addEventListener('click', () => {
          guideModal.style.display = 'block';
        });

        closeButtons.forEach(button => {
          button.addEventListener('click', () => {
            guideModal.style.display = 'none';
          });
        });

        window.addEventListener('click', (event) => {
          if (event.target === guideModal) {
            guideModal.style.display = 'none';
          }
        });
      }
    });

    function deleteCategory(id) {
      if (confirm("Are you sure you want to delete this category?")) {
        fetch(`/deleteGuideCategory/${id}`, { method: 'DELETE' })
                .then(() => {
                  location.reload(); // no alert here
                })
                .catch(err => alert("Delete failed: " + err));
      }
    }

    function deleteFarmGuide(id) {
      if (confirm("Are you sure you want to delete this Guide?")) {
        fetch(`/deleteFarmGuide/${id}`, { method: 'DELETE' })
                .then(() => {
                  location.reload();
                })
                .catch(err => alert("Delete failed: " + err));
      }
    }

    function editCategory(id) {
      document.querySelector('#addCategoryModal h3').textContent = 'Update Guide Category';

      // Fetch category details (you’ll need a backend endpoint for this)
      fetch(`/getGuideCategory/${id}`)
              .then(res => res.json())
              .then(data => {
                // Set form values
                document.getElementById('categoryName').value = data.name;
                document.getElementById('categoryDescription').value = data.description;
                document.getElementById('CategoryIcon').value = data.iconClass;
                document.getElementById('categoryStatus').checked = data.status === 'on';
                document.getElementById('editId').value = data.id;

                // Change form action to update endpoint
                const form = document.getElementById('addCategoryForm');
                form.action = `/updateGuideCategory/${id}`;

                // Show modal
                document.getElementById('addCategoryModal').style.display = 'block';
              })
              .catch(err => alert("Failed to load category: " + err));
    }

    function editFarmGuide(id) {
      document.querySelector('#addGuideModal h3').textContent = 'Update Guide';

      fetch(`/getFarmGuide/${id}`)
              .then(res => res.json())
              .then(data => {
                document.getElementById('addGuideForm').reset();

                document.getElementById('title').value = data.title;
                document.getElementById('excerpt').value = data.excerpt;
                document.getElementById('content').value = data.content;
                document.getElementById('category').value = data.category;
                document.getElementById('subcategory').value = data.subcategory;
                document.getElementById('status').value = data.status;
                document.getElementById('keywords').value = data.keywords;
                document.getElementById('sourceName').value = data.sourceName;
                document.getElementById('sourceUrl').value = data.sourceUrl;
                document.getElementById('editFarmId').value = data.id;

                const featuredValue = data.featured ? "true" : "false";
                document.querySelector(`input[name="featured"][value="${featuredValue}"]`).checked = true;

                const form = document.getElementById('addGuideForm');
                form.action = `/updateFarmGuide/${data.id}`;
                form.method = "POST";

                document.getElementById('addGuideModal').style.display = 'block';
              })
              .catch(err => {
                console.error("Failed to load guide:", err);
                alert("Failed to load guide details");
              });
    }

    function readFarmGuide(id) {
      fetch(`/getFarmGuide/${id}`)
              .then(res => res.json())
              .then(data => {
                // Populate the modal with guide data
                document.getElementById('readGuideTitle').textContent = data.title;
                document.getElementById('readGuideContent').textContent = data.content;

                // Format and display date
                const date = new Date(data.createdAt);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('readGuideDate').textContent = date.toLocaleDateString('en-US', options);

                // Set featured image if available
                const imageElement = document.getElementById('readGuideImage');
                if (data.featuredImage) {
                  imageElement.style.backgroundImage = `url('/uploads/farmguides/${data.featuredImage}')`;
                  imageElement.style.display = 'block';
                } else {
                  imageElement.style.display = 'none';
                }

                // Show the modal
                document.getElementById('readGuideModal').style.display = 'block';
              })
              .catch(err => {
                console.error("Failed to load guide:", err);
                alert("Failed to load guide details");
              });
    }

    const readGuideModal = document.getElementById('readGuideModal');

    const closeButtons = document.querySelectorAll('.admin-modal-close');
    closeButtons.forEach(button => {
      button.addEventListener('click', () => {
        if (readGuideModal) readGuideModal.style.display = 'none';
      });
    });

    window.addEventListener('click', (event) => {
      if (readGuideModal && event.target === readGuideModal) {
        readGuideModal.style.display = 'none';
      }
    });

    function generateSlug(title) {
      return title.toLowerCase()
              .replace(/[^a-z0-9\s-]/g, "")  // Remove special chars
              .replace(/\s+/g, "-")          // Replace spaces with hyphens
              .replace(/-+/g, "-");           // Collapse multiple hyphens
    }

    async function isNotFeatured(id) {
      if (!confirm("Are you sure you want to remove this from featured?")) return;

      try {
        const res = await fetch(`/farm-guides/${id}/remove-featured`, {
          method: "POST"
        });
        location.reload();
      } catch (err) {
        console.error("Failed to remove from featured:", err);
        alert("Error occurred while removing");
      }
    }

    async function movePositionUp(id) {
      try {
        const res = await fetch(`/farm-guides/${id}/move-up`, { method: "POST" });
        const message = await res.text();
        alert(message);
        location.reload();
      } catch (err) {
        console.error("Error moving up:", err);
        alert("Move up failed");
      }
    }

    async function movePositionDown(id) {
      try {
        const res = await fetch(`/farm-guides/${id}/move-down`, { method: "POST" });
        const message = await res.text();
        alert(message);
        location.reload();
      } catch (err) {
        console.error("Error moving down:", err);
        alert("Move down failed");
      }
    }

  </script>
</body>
</html>